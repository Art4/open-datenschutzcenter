{% extends 'base.html.twig' %}

{% block title %}{{ team.name }}{% endblock %}

{% block body %}
    <div class="row wow fadeIn mt-5">

        <!--Grid column-->
        <div class="col-xl-6 col-lg-4 mb-4">
            {{ include ('dashboard/__cards.html.twig') }}
            <div class="d-none d-xl-block mt-5">
                {{ include('dashboard/__critical.html.twig') }}
            </div>
        </div>
        <!--Grid column-->

        <!--Grid column-->
        <div class="col-xl-6 col-lg-8 mb-4">

            {{ include('dashboard/__assign.html.twig') }}

            <!--Card-->
            <div class="card mt-3">
                <!-- Card header -->
                <div class="card-header text-center">
                    Letzte Ã„nderungen
                </div>
                <!--Card content-->
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="h5-responsive">Auditfragen</h5>
                            <hr>
                            <ul>
                                {% for a in audit|slice(0, 5) %}
                                    <a href="{{ path('audit_tom_edit', {'tom':a.id}) }}"><img style="width: 14px"
                                                                                              src="{{ asset('images/pruefung.png') }}"> {{ a.frage }}
                                    </a><br>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5 class="h5-responsive">Verarbeitungen</h5>
                            <hr>
                            <ul>
                                {% for v in vvt|slice(0, 5) %}
                                    <img style="width: 14px" src="{{ asset('images/prozess.png') }}"> <a
                                        href="{{ path('vvt_edit', {'id':v.id}) }}">{{ v.name }}</a><br>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>


                </div>

            </div>
            <!--/.Card-->
            <div class="d-block d-xl-none mt-3">
                {{ include('dashboard/__critical.html.twig') }}
            </div>

        </div>
    </div>
    <div class="card">
        <div class="card-header text-center">
            Datenschutzcenter Netzplan
        </div>
        <div class="card-body">
            <label>
                <select id="nodeFilterSelect" class="custom-select-lg">
                    <option value>Alle Abteilungen</option>
                    {% for a in app.user.team.abteilungen if a.activ %}
                        <option value="ab{{ a.id }}">{{ a.name }}</option>
                    {% endfor %}
                </select>
            </label>
            <div id="mynetwork"></div>
        </div>
    </div>

{% endblock %}

{% block javascripts %}
    <script type="text/javascript">
        const nodeFilterSelector = document.getElementById("nodeFilterSelect");

        function startNetwork(data) {
            const container = document.getElementById("mynetwork");
            const options = {
                layout: {
                    hierarchical: {
                        direction: "UD",
                        sortMethod: "directed",
                        parentCentralization: false
                    }
                },
                autoResize: true,
                physics: {
                    physics: false,
                    hierarchicalRepulsion: {
                        avoidOverlap: 1
                    }
                },
            };
            var network = new vis.Network(container, data, options);

            network.on("doubleClick", function (params) {
                if (params.nodes.length === 1) {
                    var node = nodes.get(params.nodes[0]);
                    if (node.url != null) {
                        window.open(node.url, "_self");
                    }
                }
            });
        }

        const nodes = new vis.DataSet([

            {% for n in vvt %}
            {
                id: 'vvt{{ n.id }}',
                {% if n.abteilung %}
                ab{{ n.abteilung.id }}:
                    '{{ n.abteilung.id }}',
                {% endif %}
            title
        :
        '{{ n.name }}',
            label
        :
        '{{ n.name|slice(0,28) }}',
            color
        :
        '#34ce57',
            font
        :
        {
            face: "Monospace"
        }
        ,
        shape: "box",
            url
        :
        "{{ path('vvt_edit', {'id':n.id}) }}"
        },

        {% for s in n.software if s.activ %}
        {
            id: 'software{{ s.id }}',
                    {% if n.abteilung %}
                ab{{ n.abteilung.id }}:
            '{{ n.abteilung.id }}',
                    {% endif %}
                title
        :
            '{{ s.name }}',
                label
        :
            '{{ s.name|slice(0,28) }}',
                color
        :
            '#2E9AFE',
                font
        :
            {
                face: "Monospace"
            }
        ,
            shape: "box",
                url
        :
            "{{ path('software_edit', {'id':s.id}) }}"
        }
        ,
        {% endfor %}


        {% endfor %}




        {% for n in daten %}
        {
            id: 'daten{{ n.id }}',
                    {% for v in n.verfahren if v.activ %}
                    {% if v.abteilung %}
                ab{{ v.abteilung.id }}:
            '{{ v.abteilung.id }}',
                    {% endif %}
                    {% endfor %}
                label
        :
            'DW \n{{ n.gegenstand }}',
                color
        :
            '#6f42c1',
                font
        :
            {
                face: "Monospace", color
            :
                'white'
            }
        ,
            shape: "box",
                url
        :
            "{{ path('datenweitergabe_edit', {'id':n.id}) }}"
        }
        ,
        {% endfor %}
        {% for n in av %}
        {
            id: 'daten{{ n.id }}',
            {% for v in n.verfahren if v.activ %}
                    {% if v.abteilung %}
                ab{{ v.abteilung.id }}:
            '{{ v.abteilung.id }}',
                    {% endif %}
                    {% endfor %}
                label
        :
            'AV \n{{ n.gegenstand }}',
                color
        :
            '#7e57c2',
                font
        :
            {
                face: "Monospace", color
            :
                'white'
            }
        ,
            shape: "box",
                url
        :
            "{{ path('datenweitergabe_edit', {'id':n.id}) }}"
        }
        ,
        {% endfor %}
        {% for n in tom %}
        {
            id: 'tom{{ n.id }}',
            {% for v in n.vvts if v.activ %}
                    {% if v.abteilung %}
                ab{{ v.abteilung.id }}:
            '{{ v.abteilung.id }}',
                    {% endif %}
                    {% endfor %}
                label
        :
            'TOM \n{{ n.titel }}',
                color
        :
            '#0e4377',
                font
        :
            {
                face: "Monospace", color
            :
                'white'
            }
        ,
            shape: "box",
                url
        :
            "{{ path('tom_edit', {'tom':n.id}) }}",
        }
        ,
        {% endfor %}
        {% for n in policies %}
        {
            id: 'pol{{ n.id }}',
                label
        :
            'POLICY \n{{ n.title }}',
                color
        :
            '#4b515d',
                font
        :
            {
                face: "Monospace", color
            :
                'white'
            }
        ,
            shape: "box",
                url
        :
            "{{ path('policy_edit', {'id':n.id}) }}",
            {% for v in n.processes if v.activ %}
                    {% if v.abteilung %}
                ab{{ v.abteilung.id }}:
            '{{ v.abteilung.id }}',
            {% endif %}
            {% endfor %}
        }
        ,
        {% endfor %}
        {% for n in kontakte %}
        {
            id: 'kon{{ n.id }}',
                label
        :
            'KONTAKT \n{{ n.firma }}',
                color
        :
            '#6a1b9a',
                font
        :
            {
                face: "Monospace", color
            :
                'white'
            }
        ,
            shape: "box",
                url
        :
            "{{ path('kontakt_edit', {'id':n.id}) }}",
            {% for d in n.datenweitergaben if d.activ %}
            {% for v in d.verfahren if v.activ %}
                    {% if v.abteilung %}
                ab{{ v.abteilung.id }}:
            '{{ v.abteilung.id }}',
            {% endif %}
            {% endfor %}
            {% endfor %}
        }
        ,
        {% endfor %}
        ])
        ;

        const edges = new vis.DataSet([

            {% for ee in vvt %}
            {% for e in ee.datenweitergaben if e.activ %}
            {% if e.art == 2 %}
            {from: 'vvt{{ ee.id }}', to: 'daten{{ e.id }}'},
            {% else %}
            {from: 'daten{{ e.id }}', to: 'vvt{{ ee.id }}'},
            {% endif %}
            {% endfor %}
            {% if ee.tomLink is not null %}
            {from: 'vvt{{ ee.id }}', to: 'tom{{ ee.tomLink.id }}'},
            {% endif %}

            {% for e in ee.software if e.activ %}
            {from: 'software{{ e.id }}', to: 'vvt{{ ee.id }}'},
            {% for d in e.datenweitergabe if d.activ %}
            {from: 'daten{{ d.id }}', to: 'software{{ e.id }}'},
            {% endfor %}
            {% endfor %}

            {% for e in ee.policies if e.activ %}
            {from: 'vvt{{ ee.id }}', to: 'pol{{ e.id }}'},
            {% endfor %}
            {% endfor %}

            {% for ee in kontakte %}
            {% for e in ee.datenweitergaben if e.activ %}
            {% if e.art == 2 %}
            {from: 'daten{{ e.id }}', to: 'kon{{ ee.id }}'},
            {% else %}
            {from: 'kon{{ ee.id }}', to: 'daten{{ e.id }}'},
            {% endif %}
            {% endfor %}
            {% endfor %}
        ]);

        /**
         * filter values are updated in the outer scope.
         * in order to apply filters to new values, DataView.refresh() should be called
         */
        let nodeFilterValue = "";

        /*
        filter function should return true or false
        based on whether item in DataView satisfies a given condition.
        */
        const nodesFilter = node => {
            if (nodeFilterValue === "") {
                return true;
            }
            switch (nodeFilterValue) {
                    {% for a in app.user.team.abteilungen if a.activ %}
                case "ab{{ a.id }}":
                    return node.ab{{ a.id }} === "{{ a.id }}";
                    {% endfor %}
                default:
                    return true;
            }
        };

        const nodesView = new vis.DataView(nodes, {filter: nodesFilter});

        nodeFilterSelector.addEventListener("change", e => {
            // set new value to filter variable
            nodeFilterValue = e.target.value;
            /*
                  refresh DataView,
                  so that its filter function is re-calculated with the new variable
                */
            nodesView.refresh();
        });

        startNetwork({nodes: nodesView, edges: edges});
    </script>

{% endblock %}
